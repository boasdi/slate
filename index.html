<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>thethings.iO Cloud Code API Reference</title>

    <style>
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight, .highlight .w {
  color: #f8f8f2;
  background-color: #272822;
}
.highlight .err {
  color: #151515;
  background-color: #ac4142;
}
.highlight .c, .highlight .cd, .highlight .cm, .highlight .c1, .highlight .cs {
  color: #505050;
}
.highlight .cp {
  color: #f4bf75;
}
.highlight .nt {
  color: #f4bf75;
}
.highlight .o, .highlight .ow {
  color: #d0d0d0;
}
.highlight .p, .highlight .pi {
  color: #d0d0d0;
}
.highlight .gi {
  color: #90a959;
}
.highlight .gd {
  color: #ac4142;
}
.highlight .gh {
  color: #6a9fb5;
  background-color: #151515;
  font-weight: bold;
}
.highlight .k, .highlight .kn, .highlight .kp, .highlight .kr, .highlight .kv {
  color: #aa759f;
}
.highlight .kc {
  color: #d28445;
}
.highlight .kt {
  color: #d28445;
}
.highlight .kd {
  color: #d28445;
}
.highlight .s, .highlight .sb, .highlight .sc, .highlight .sd, .highlight .s2, .highlight .sh, .highlight .sx, .highlight .s1 {
  color: #90a959;
}
.highlight .sr {
  color: #75b5aa;
}
.highlight .si {
  color: #8f5536;
}
.highlight .se {
  color: #8f5536;
}
.highlight .nn {
  color: #f4bf75;
}
.highlight .nc {
  color: #f4bf75;
}
.highlight .no {
  color: #f4bf75;
}
.highlight .na {
  color: #6a9fb5;
}
.highlight .m, .highlight .mf, .highlight .mh, .highlight .mi, .highlight .il, .highlight .mo, .highlight .mb, .highlight .mx {
  color: #90a959;
}
.highlight .ss {
  color: #90a959;
}
    </style>
    <link href="stylesheets/screen.css" rel="stylesheet" media="screen" />
    <link href="stylesheets/print.css" rel="stylesheet" media="print" />
      <script src="javascripts/all.js"></script>
  </head>

  <body class="index" data-languages="[&quot;json&quot;,&quot;shell&quot;,&quot;ruby&quot;,&quot;python&quot;,&quot;javascript&quot;]">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar.png" />
      </span>
    </a>
    <div class="tocify-wrapper">
        <div class="lang-selector">
              <a href="#" data-language-name="json">Sample Payload / Sample Response</a>
              <a href="#" data-language-name="shell">cURL</a>
              <a href="#" data-language-name="ruby">ruby</a>
              <a href="#" data-language-name="python">python</a>
              <a href="#" data-language-name="javascript">javascript</a>
        </div>
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <div id="toc">
      </div>
        <ul class="toc-footer">
            <li><a href='https://github.com/theThings/thethings.iO-arduino-library'>Arduino library</a></br></li>
            <li><a href='https://github.com/theThings/thethings.iO-python-library'>Python library</a></br></li>
            <li><a href='https://github.com/theThings/thethings.iO-TexasInstruments-library'>Texas Instruments library</a></br></br> <a href='https://github.com/tripit/slate'>Documentation Powered by Slate</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <h1 id="basics">Basics</h1>

<h2 id="cloud-code-sandbox">Cloud Code Sandbox</h2>

<p>Sometimes you need to execute a part of your bussiness logic in a server. You can execute JavaScript code at thethings.iO cloud using the Cloud Code API.</p>

<p>There are three types of Cloud Code: triggers, jobs and functions.</p>

<ul>
<li>   Triggers are executed when an event occurs like a thingWrite.</li>
<li>   Jobs are tasks executed once every hour or day.</li>
<li>   Functions are snippets of code executed with a REST API call.</li>
</ul>

<p>You can use triggers to send alarms when the temperature is higher than a treshold or generate events to aggregate later in a job.</p>

<h3 id="product-trigger-example-todo-imagenes-cambiar-redacci-n-de-texto-seg-n-esto">Product Trigger Example TODO: imagenes? cambiar redacción de texto según esto</h3>
<pre class="highlight javascript"><code><span class="kd">function</span> <span class="nx">trigger</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'trigger triggered!!'</span><span class="p">)</span>
  <span class="c1">//igrnore non wirte events</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">action</span> <span class="o">!==</span> <span class="s1">'write'</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">()</span>

  <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">values</span>
  <span class="kd">var</span> <span class="nx">thingToken</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">thingToken</span>

  <span class="c1">//iterate over the values of the write</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">key</span> <span class="o">===</span> <span class="s1">'temperature'</span> <span class="o">&amp;&amp;</span> <span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">value</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">){</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'omg too hot'</span><span class="p">)</span>
      <span class="nx">email</span><span class="p">(</span>
        <span class="p">{</span>
          <span class="na">service</span> <span class="p">:</span> <span class="s1">'SendGrid'</span><span class="p">,</span>
          <span class="na">auth</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">api_user</span><span class="p">:</span> <span class="s1">'YOUR API USER'</span><span class="p">,</span>
            <span class="na">api_key</span><span class="p">:</span> <span class="s1">'YOUR API KEY'</span>
          <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="na">from</span><span class="p">:</span> <span class="s1">'your@email.com'</span><span class="p">,</span>
          <span class="na">to</span><span class="p">:</span> <span class="s1">'to@receiver.com'</span><span class="p">,</span>
          <span class="na">subject</span> <span class="p">:</span> <span class="s1">'The temperature is too high'</span><span class="p">,</span>
          <span class="na">text</span> <span class="p">:</span> <span class="s1">'Master, it’s too hot here! \n\n Always yours,\n '</span><span class="o">+</span> <span class="nx">thingToken</span>
        <span class="p">}</span>
      <span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">//end the trigger</span>
  <span class="nx">callback</span><span class="p">()</span>
<span class="p">}</span>
</code></pre>

<p>This is a description of how you can set and manage a trigger for a product.</p>

<p>First, go to the Cloud code view clicking on the &lsquo;Cloud code&rsquo; link at the left sidebar.</p>

<p>As you can see, this view is empty because you haven&rsquo;t created a trigger. Later, you will manage your triggers (list, delete and edit) from this view.</p>

<p>Now, just click at the &#39;Add Trigger&rsquo; button and you&rsquo;ll see the next form:</p>

<p>This form is very straight forward, you only have to name the trigger, choose the product which you want to apply the trigger, put the code and save.</p>

<p>Once added, the trigger will subscribe to all the devices of a product. That means that every time an event on your devices occurs, we execute the trigger code.</p>

<p>For example (next code example), if a device writes a temperature value of 25, the trigger is triggered and will get this value via the params argument. If our trigger is configured to send an email every time a value is up to 50, the code will compare 25 and 50, and will do nothing. But if the device writes a 60, then the trigger will send an email alerting us.</p>

<h3 id="javascript-exposed-methods">Javascript exposed methods</h3>

<p>The provided Cloud code sandbox only exposes some basic methods:</p>

<ul>
<li>&#39;setTimeout&rsquo;,</li>
<li>  &#39;setInterval&rsquo;,</li>
<li>   &#39;clearTimeout&rsquo;,</li>
<li>   &#39;clearInterval&rsquo;</li>
</ul>

<p>And the exposed services described at our documentation: Exposed APIs</p>

<h1 id="triggers">Triggers</h1>

<h2 id="triggers">Triggers</h2>

<p>Triggers are snippets of code executed after an event happens like a thingWrite. You can use a trigger to send an alarm or generate an event to be aggregated later. Also you can call external web services.</p>

<p>Each trigger must contain a <strong>function trigger(params, callback)</strong></p>

<p>Where:</p>

<p><strong>params</strong> is an object with the keys:</p>

<ul>
<li>   action: one of &#39;write&rsquo; | &#39;read&rsquo;</li>
<li>   thingToken: the thing that triggered the trigger</li>
<li>   values: only if action == &#39;write&rsquo;. Is an array of values where each value is an object with:

<ul>
<li>key: the key</li>
<li>value: the data sent</li>
<li>datetime: (can be null)</li>
</ul></li>
</ul>

<p><strong>callback</strong> is a function to be called when the trigger ends can contain a parameter string error if the trigger needs to report an error.</p>

<p>The execution of a trigger is <strong>limited to 2 seconds.</strong> If the execution takes longer, the server will end the sandbox.</p>

<h2 id="setup-alarm">Setup Alarm</h2>

<blockquote>
<p>This code sends an email when the temperature is higher than 50 degrees to &#39;to@receiver.com&rsquo;. </p>
</blockquote>
<pre class="highlight javascript"><code><span class="kd">function</span> <span class="nx">trigger</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'trigger triggered!!'</span><span class="p">)</span>
  <span class="c1">//ignore non write events</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">action</span> <span class="o">!==</span> <span class="s1">'write'</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">()</span>

  <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">values</span>
  <span class="kd">var</span> <span class="nx">thingToken</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">thingToken</span>

  <span class="c1">//iterate over the values of the write</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">key</span> <span class="o">===</span> <span class="s1">'temperature'</span> <span class="o">&amp;&amp;</span> <span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">value</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">){</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'omg too hot'</span><span class="p">)</span>
      <span class="nx">email</span><span class="p">(</span>
        <span class="p">{</span>
          <span class="na">service</span> <span class="p">:</span> <span class="s1">'SendGrid'</span><span class="p">,</span>
          <span class="na">auth</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">api_user</span><span class="p">:</span> <span class="s1">'YOUR API USER'</span><span class="p">,</span>
            <span class="na">api_key</span><span class="p">:</span> <span class="s1">'YOUR API KEY'</span>
          <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="na">from</span><span class="p">:</span> <span class="s1">'your@email.com'</span><span class="p">,</span>
          <span class="na">to</span><span class="p">:</span> <span class="s1">'to@receiver.com'</span><span class="p">,</span>
          <span class="na">subject</span> <span class="p">:</span> <span class="s1">'The temperature is too high'</span><span class="p">,</span>
          <span class="na">text</span> <span class="p">:</span> <span class="s1">'Master, it’s too hot here! \n\n Always yours,\n '</span><span class="o">+</span> <span class="nx">thingToken</span>
        <span class="p">}</span>
      <span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">//end the trigger</span>
  <span class="nx">callback</span><span class="p">()</span>
<span class="p">}</span>
</code></pre>

<p>The example code provided here sends an email when the temperature is higher than 50 degrees to &#39;to@receiver.com&rsquo;. See the javascript section.</p>

<h2 id="generate-events">Generate events</h2>

<blockquote>
<p>The following code generates a simple event which stores the value to an event called &#39;temperature&rsquo;. </p>
</blockquote>
<pre class="highlight javascript"><code><span class="kd">function</span> <span class="nx">trigger</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'trigger triggered!!'</span><span class="p">)</span>
  <span class="c1">//igrnore non wirte events</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">action</span> <span class="o">!==</span> <span class="s1">'write'</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">()</span>
  <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">values</span>
  <span class="c1">//iterate over the values of the write</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">){</span>
    <span class="nx">analytics</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span><span class="na">name</span><span class="p">:</span><span class="s1">'temperature'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span><span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">value</span><span class="p">})</span>
  <span class="p">}</span>
  <span class="c1">//end the trigger</span>
  <span class="nx">callback</span><span class="p">()</span>
<span class="p">}</span>
</code></pre>

<p>You can generate events from inside the code. The example provided here generates a simple event which stores the value to an event called &#39;temperature&rsquo;. To be later retrieved from a*<em>job</em>*. See the javascript section.</p>

<h2 id="playing-with-geolocation">Playing with geolocation</h2>

<blockquote>
<p>This code shows how you can combine geolib and the geolocation of your things to send an email when your thing is not inside a predefined circle.</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">MAX_DISTANCE</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">trigger</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
  <span class="c1">//ignore non write events</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">action</span> <span class="o">!==</span> <span class="s1">'write'</span><span class="p">){</span>
   <span class="k">return</span> <span class="nx">callback</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">position</span> <span class="o">=</span> <span class="kc">null</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">params</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">){</span>
   <span class="k">if</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">key</span> <span class="o">===</span> <span class="s1">'location'</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">geo</span><span class="p">){</span>
     <span class="nx">position</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">geo</span>
    <span class="p">}</span>
   <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">//also we ignore the keys that are not location and don't have geolocation</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">position</span><span class="p">){</span>
   <span class="k">return</span> <span class="nx">callback</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="c1">//get the thing description resource</span>
  <span class="nx">httpRequest</span><span class="p">({</span>
    <span class="na">host</span><span class="p">:</span> <span class="s1">'api.thethings.io'</span><span class="p">,</span>
    <span class="na">path</span><span class="p">:</span> <span class="s1">'/v2/things/'</span><span class="o">+</span><span class="nx">params</span><span class="p">.</span><span class="nx">thingToken</span><span class="o">+</span><span class="s1">'/resources/description'</span>
  <span class="p">},</span><span class="nx">response</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">position</span><span class="p">))</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">response</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">position</span><span class="p">){</span>
 <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">headers</span><span class="p">,</span> <span class="nx">data</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">callback</span><span class="p">()</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
     <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
     <span class="c1">//ensure that the description is defined with coordinates</span>
     <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="o">!</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">.</span><span class="nx">coordinates</span><span class="p">){</span>
         <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">'description not defined with coordinates'</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">()</span>
     <span class="p">}</span>
     <span class="kd">var</span> <span class="nx">coordinates</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">.</span><span class="nx">coordinates</span>
     <span class="c1">//check if the position is inside the circle</span>
     <span class="kd">var</span> <span class="nx">inside</span> <span class="o">=</span> <span class="nx">geolib</span><span class="p">.</span><span class="nx">isPointInCircle</span><span class="p">(</span>
        <span class="p">{</span><span class="na">latitude</span><span class="p">:</span> <span class="nx">position</span><span class="p">.</span><span class="nx">lat</span><span class="p">,</span> <span class="na">longitude</span><span class="p">:</span> <span class="nx">position</span><span class="p">.</span><span class="kr">long</span><span class="p">},</span>
        <span class="p">{</span><span class="na">latitude</span><span class="p">:</span> <span class="nx">coordinates</span><span class="p">.</span><span class="nx">lat</span><span class="p">,</span> <span class="na">longitude</span><span class="p">:</span> <span class="nx">coordinates</span><span class="p">.</span><span class="kr">long</span><span class="p">},</span>
        <span class="nx">MAX_DISTANCE</span>
    <span class="p">);</span>
     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'inside'</span><span class="p">,</span> <span class="nx">inside</span><span class="p">,</span> <span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">.</span><span class="nx">email</span><span class="p">)</span>
     <span class="c1">//generate an analytics event to get data insigts later</span>
     <span class="nx">analytics</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span><span class="na">name</span><span class="p">:</span><span class="s1">'inside'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span><span class="nx">inside</span><span class="p">})</span>
     <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">inside</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">.</span><span class="nx">email</span><span class="p">){</span>
       <span class="c1">//if the email is defined send a warning email</span>
      <span class="nx">sendWarningEmail</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span><span class="nx">position</span><span class="p">)</span>
     <span class="p">}</span>
     <span class="nx">callback</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//this function geneartes and sends a cool warning email</span>
<span class="kd">function</span> <span class="nx">sendWarningEmail</span><span class="p">(</span><span class="nx">receiver</span><span class="p">,</span> <span class="nx">coords</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">coordsStr</span> <span class="o">=</span> <span class="s1">'&lt;a href="https://www.google.com/maps/dir//'</span><span class="o">+</span><span class="nx">coords</span><span class="p">.</span><span class="nx">lat</span><span class="o">+</span><span class="s1">','</span><span class="o">+</span><span class="nx">coords</span><span class="p">.</span><span class="kr">long</span><span class="o">+</span><span class="s1">'/@'</span><span class="o">+</span><span class="nx">coords</span><span class="p">.</span><span class="nx">lat</span><span class="o">+</span><span class="s1">','</span><span class="o">+</span><span class="nx">coords</span><span class="p">.</span><span class="kr">long</span><span class="o">+</span><span class="s1">',15z"&gt;https://www.google.com/maps/dir//'</span><span class="o">+</span><span class="nx">coords</span><span class="p">.</span><span class="nx">lat</span><span class="o">+</span><span class="s1">','</span><span class="o">+</span><span class="nx">coords</span><span class="p">.</span><span class="kr">long</span><span class="o">+</span><span class="s1">'/@'</span><span class="o">+</span><span class="nx">coords</span><span class="p">.</span><span class="nx">lat</span><span class="o">+</span><span class="s1">','</span><span class="o">+</span><span class="nx">coords</span><span class="p">.</span><span class="kr">long</span><span class="o">+</span><span class="s1">',15z&lt;/a&gt;'</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'sending email to'</span><span class="p">,</span> <span class="nx">receiver</span><span class="p">)</span>
  <span class="nx">email</span><span class="p">(</span>
    <span class="p">{</span>
      <span class="na">service</span><span class="p">:</span> <span class="s1">'SendGrid'</span><span class="p">,</span>
      <span class="na">auth</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">api_user</span><span class="p">:</span> <span class="s1">'YOUR API USER'</span><span class="p">,</span>
        <span class="na">api_key</span><span class="p">:</span> <span class="s1">'YOUR API KEY'</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="na">from</span> <span class="p">:</span> <span class="s1">'thingswarner@thethings.io'</span><span class="p">,</span> <span class="c1">//this email is completly random</span>
      <span class="na">to</span><span class="p">:</span> <span class="nx">receiver</span><span class="p">,</span>
      <span class="na">subject</span><span class="p">:</span> <span class="s1">'Your thing has escaped!'</span><span class="p">,</span>
      <span class="na">text</span><span class="p">:</span> <span class="s1">'Your thing has escaped from the safe zone!\n \n Last seen in: '</span><span class="o">+</span><span class="nx">coordsStr</span><span class="o">+</span><span class="s1">' \n\n Att,\n Overlord'</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre>

<p>The example provided here shows how you can combine geolib and the geolocation of your things to send an email when your thing is not inside a predefined circle.
In the example the description key/resource is used to store the predefined coordinates and the user&rsquo;s email. See the javascript section.</p>

<h1 id="jobs">Jobs</h1>

<h2 id="jobs">Jobs</h2>

<p>Jobs are tasks executed once every hour or once a day. You can use the jobs to generate your own kpis and analytics aggregating the data from the events.</p>

<p>Each job must contain a <strong>function job(params, callback)</strong></p>

<p>Where:</p>

<ul>
<li><p><strong>params</strong> is an empty object for now.</p></li>
<li><p><strong>callback</strong> is a function to be called when the trigger ends can contain a parameter string error if the trigger needs to report an error.</p></li>
</ul>

<p>The execution of a job is limited to 10 minutes. If the execution takes longer, the server will end the sandbox.</p>

<p>The common use of jobs is to get the data from the events process it and send to a kpi. But any of the available services can be used at any moment.</p>

<h2 id="example-average-temperature">Example: Average temperature</h2>

<blockquote>
<p>The following code takes all events with the type temperature and separates them in two groups, with temperature higher than 0 an lower than 0. Then computes the average and stores to a kpi called avg-temperature: </p>
</blockquote>
<pre class="highlight javascript"><code><span class="kd">function</span> <span class="nx">job</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
  <span class="nx">analytics</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">getValuesByName</span><span class="p">(</span><span class="s1">'temperature'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">data</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nx">high0</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">){</span><span class="k">return</span> <span class="nx">val</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">}).</span><span class="nx">avg</span><span class="p">()</span>
    <span class="kd">var</span> <span class="nx">low0</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">){</span><span class="k">return</span> <span class="nx">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">}).</span><span class="nx">avg</span><span class="p">()</span>
    <span class="nx">analytics</span><span class="p">.</span><span class="nx">kpis</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="s1">'avg-temperature'</span><span class="p">,{</span><span class="na">high</span><span class="p">:</span><span class="nx">high0</span><span class="p">,</span><span class="na">low</span><span class="p">:</span><span class="nx">low0</span><span class="p">})</span>
    <span class="nx">callback</span><span class="p">()</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre>

<p>The example provided here takes all events with the type temperature and separates them in two groups, with temperature higher than 0 an lower than 0. Then computes the average and stores to a kpi called avg-temperature.</p>

<p>See the javascript section.</p>

<h2 id="example-top-10-scores">Example: Top 10 scores</h2>

<blockquote>
<p>This code sorts the data and gets the top ten values. </p>
</blockquote>
<pre class="highlight javascript"><code><span class="kd">function</span> <span class="nx">job</span><span class="p">(</span><span class="nx">callback</span><span class="p">){</span>
  <span class="nx">analytics</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">getValuesByName</span><span class="p">(</span><span class="s1">'score'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">data</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nx">top10</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">){</span><span class="k">return</span> <span class="nx">b</span><span class="o">-</span><span class="nx">a</span><span class="p">}).</span><span class="nx">take</span><span class="p">(</span><span class="mi">10</span><span class="p">).</span><span class="nx">collect</span><span class="p">()</span>
    <span class="nx">analytics</span><span class="p">.</span><span class="nx">kpis</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="s1">'top-10'</span><span class="p">,</span> <span class="nx">top10</span><span class="p">)</span>
    <span class="nx">callback</span><span class="p">()</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre>

<p>The example provided here sorts the data and gets the top ten values. </p>

<p>See the javascript section.</p>

<h2 id="example-percentiles">Example: Percentiles</h2>

<blockquote>
<p>This code splits the data in 10 parts and gets the median of each one i.e. the values in 5%, 15%, 25%, &hellip; , 95%. </p>
</blockquote>
<pre class="highlight javascript"><code><span class="kd">function</span> <span class="nx">job</span><span class="p">(</span><span class="nx">callback</span><span class="p">){</span>
  <span class="nx">analytics</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">getByName</span><span class="p">(</span><span class="s1">'noise'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">data</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nx">noisePercentiles</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sort</span><span class="p">().</span><span class="nx">percentiles</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="nx">analytics</span><span class="p">.</span><span class="nx">kpis</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="s1">'noise-percentiles'</span><span class="p">,</span><span class="nx">noisePercentiles</span><span class="p">)</span>
    <span class="nx">callback</span><span class="p">()</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre>

<p>The example provided here splits the data in 10 parts and gets the median of each one i.e. the values in 5%, 15%, 25%, &hellip; , 95%. </p>

<h2 id="example-square-of-sum-of-squares">Example: Square of sum of squares</h2>
<pre class="highlight javascript"><code><span class="kd">function</span> <span class="nx">job</span><span class="p">(</span><span class="nx">callback</span><span class="p">){</span>
  <span class="nx">analytics</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">getValuesByName</span><span class="p">(</span><span class="s1">'myevent'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">data</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">){</span><span class="k">return</span> <span class="nx">val</span><span class="o">*</span><span class="nx">val</span><span class="p">}).</span><span class="nx">sum</span><span class="p">())</span>
    <span class="nx">analytics</span><span class="p">.</span><span class="nx">kpis</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="s1">'my-kpi'</span><span class="p">,</span><span class="nx">res</span><span class="p">)</span>
    <span class="nx">callback</span><span class="p">()</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre>

<h1 id="functions">Functions</h1>

<h2 id="functions">Functions</h2>

<p>Functions are snipets of code executed when an API REST endpoint is called. They can also be called from other parts of the cloud code like triggers and jobs. They are useful to encapsulate business logic that you don&rsquo;t want into the devices.</p>

<p>Each function must contain a <strong>function main(params, callback)</strong></p>

<p>Where:</p>

<ul>
<li><p><strong>params</strong> is the input of the function which can be a string, object, array,&hellip;</p></li>
<li><p><strong>callback(error, result)</strong> is a function to be called when the function ends. Can contain a parameter string error if the funciton needs to report an error. If the error is null it can contain a result which will be returned as a response.</p></li>
</ul>

<p>The execution of a function is <strong>limited to 20 seconds.</strong> If the execution takes longer, the server will end the sandbox. Note that if the function is called inside a trigger the execution time will be the 2 seconds of a trigger.</p>

<h1 id="exposed-apis-ref">Exposed APIs Ref</h1>

      </div>
      <div class="dark-box">
          <div class="lang-selector">
                <a href="#" data-language-name="json">Sample Payload / Sample Response</a>
                <a href="#" data-language-name="shell">cURL</a>
                <a href="#" data-language-name="ruby">ruby</a>
                <a href="#" data-language-name="python">python</a>
                <a href="#" data-language-name="javascript">javascript</a>
          </div>
      </div>
    </div>
  </body>
</html>
